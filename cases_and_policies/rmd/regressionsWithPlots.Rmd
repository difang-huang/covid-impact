---
title       : "Causal impact of masks, policies, behavior on early COVID-19 pandemic in the U.S."
subtitle    : "Tables and Figures"
author      :  Victor Chernozhukov, Paul Schrimpf, Hiro Kasahara
job         :
date        : "`r format(Sys.time(), '%d %B, %Y')`"
bibliography: "covid.bib"
link-citations: true
always_allow_html: true
output      :
    html_document :
        toc : true
        toc_depth : 3
        toc_float : true
        number_sections : true
        #theme : journal
        #css : 628notes.css
        code_folding: hide
        #lib_dir : deps
        self_cononontained : true
        fig_width: 8
        fig_height: 6
---

 <!-- To create html files from this, in R enter  -->
 <!-- library(rmarkdown) -->
 <!-- rmarkdown::render("regressionsWithPlots.Rmd") -->
 <!-- To create tex files from this, in R enter ` -->
 <!-- library(rmarkdown) -->
 <!-- rmarkdown::render("regressionsWithPlots.Rmd", output_format=latex_fragment()) -->


 <!-- to create the gh-pages hosted website in R enter -->
 <!-- rmarkdown::render_site() -->

 <!-- Then in a shell  -->
 <!-- $ ghp-import -p -n -m "$(date)" _site -->


```{r, include=FALSE}
options(knitr.table.format = function() {
  if (knitr::is_latex_output()) 'latex' else 'pandoc'
})
if (knitr::is_latex_output()) {
  knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo=FALSE)
}
```

This file creates the figures and tables in Chernozhukov, Kasahara and
Schrimpf (2020) "Causal Impact of Masks, Policies, Behavior on Early
Covid-19 Pandemic in the U.S."

# Data Preparation
```{r setup, cache=FALSE, warning=FALSE, include=FALSE}

library(lfe)
library(stargazer)
library(knitr)
library(plm)
library(latex2exp)
library(ggplot2)
library(ggthemes)
library(estimatr)
library(gridExtra)
library(grid)
library(mvtnorm)
library(kableExtra)
library(data.table)
library(reshape2)
library(AER)
library(hdm)
library(randomForest)
library(glmnet)

sgtype <- opts_knit$get("rmarkdown.pandoc.to")
sgstyle <- 'default'
colors <-  scale_color_solarized
colors_fill <- scale_fill_solarized
rootdir <- system("git rev-parse --show-toplevel", intern=TRUE)[1]
source(paste(rootdir,"cases_and_policies/R/exploratory.R", sep="/"))
source(paste(rootdir,"cases_and_policies/R/dataprep.R",sep="/"))
source(paste(rootdir,"cases_and_policies/rmd/varlabels.R", sep="/"))
source(paste(rootdir,"cases_and_policies/rmd/regprep.R", sep="/"))
source(paste(rootdir,"cases_and_policies/rmd/generatetables.R", sep="/"))
source(paste(rootdir,"cases_and_policies/rmd/bootstrap_felm.R", sep="/"))
```

# Empirical Results

## Correlations

```{r corr, cache=FALSE}

cmat <-  cor(df[,c(bvars,pols,"pindex")], use="pairwise.complete.obs")
scmat <- matrix(sprintf("%.2f",cmat),nrow=(length(bvars)+length(pols)+1))

rownames(scmat) <- getlabel(rownames(cmat))
colnames(scmat) <- getlabel(colnames(cmat))
scmat[upper.tri(cmat)] <- ""


ltbl <- knitr::kable(scmat, format="latex", booktabs=TRUE, escape=FALSE,
              align=(rep("c",ncol(scmat)))) %>%
  row_spec(0, angle = 90)
cat(ltbl, file=paste(rootdir,"tex/tables_and_figures/corr.tex",sep="/"))

knitr::kable(scmat)
```

## Test Smoothing

We rearrange and linearly interpolate constant test counts, but do not
apply any additional smoothing.

```{r testsmooth, cache=FALSE}
rearrange <- function(x, id) {
  for (i in unique(id)) {
    xi <- x[id==i]
    xi[!is.na(xi)] <- sort(xi[!is.na(xi)])
    x[id==i] <- xi
  }
  return(x)
}


dropnotincreasing <- function(x, id, t) {
  const <- (x <= panellag(x, id, t))
  const[is.na(const)] <- FALSE
  x[const & x>0] <- NA
  return(x)
}

lininterp <- function(x, id, t) {
  for (i in unique(id)) {
    xi <- x[id==i]
    ti <- t[id==i]
    xi[is.na(xi)] <- approx(ti[!is.na(xi)], xi[!is.na(xi)], ti[is.na(xi)], rule=2)$y
    x[id==i] <- xi
  }
  return(x)
}


smoothtests <- function(x, id, t) {
  x[is.na(x)] <- 0
  return(lininterp(dropnotincreasing(rearrange(x,id),id,t),id,t))
}

df$neg.interp <- smoothtests(df$negative, df$state, df$date)
df$pos.interp <- df$cases #smoothtests(df$positive, df$state, df$date)
df$tot.interp <- df$neg.interp + df$pos.interp

L <- 7
df$tests <- paneldiff(df$tot.interp, df$state, df$date, lag=L)
df$testrate  <- df$tests/df$Population.2018*1000
#df$testrate[df$testrate<0] <- NA
df$dlogtests <- paneldiff(log(sapply(df$testrate, function(x)
  max(x,exp(-1)))), df$state, df$date, lag=L)
df$testratedc <- df$ddeath/df$dcases*df$testrate
df$testratedc[df$dcases==0] <- 0

df$tests.ma <- paneldiff(panelma(df$neg.interp, df$state, df$date, 7) + df$cases,
                         df$state, df$date, lag=L)
df$testrate.ma  <- df$tests.ma/df$Population.2018*1000
df$testrate.ma[df$testrate.ma<0] <- NA
df$dlogtests.ma <- paneldiff(log(sapply(df$testrate.ma, function(x)
  max(x,exp(-1)))), df$state, df$date, lag=L)
df$testratedc.ma <- df$ddeath/df$dcases*df$testrate.ma
df$testratedc.ma[df$dcases==0] <- 0


df$lagtests <- panellag(df$dlogtests, df$state, df$date, lag=1)
df$dlogtests[is.na(df$dlogtests)] <- df$lagtests[is.na(df$dlogtests)]

```

## Cases

```{r caseregs, cache=FALSE, warning=FALSE, results='hide'}
infovars <- list(c("dlogdc", "logdc"),
                 c("dlogdc", "logdc","dlogdc.national", "logdc.national")) #,
#c("dlogdc", "logdc"))
#infovars2 <- list(c( "logdc"))
tvars <- "dlogtests"
xlist <-list("", "")
interactions <-list("month", statevars)
ilist <- list(interactions, interactions)
iv <- list("0","0") #,"(testratedc ~ lag(testratedc,14))")


# Set time lag:
L.c <- 14
L.d <- 21
# L.c <- 9
# L.d <- 24

L <- L.c
sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
regs <- mainregressions(sdf,
                        "dlogdc", pols, bvars, infovars, tvars, xlist, ilist, iv, L=L)
```

```{r casetables, cache=FALSE, warning=FALSE, results='asis'}
showhtmltables(regs$pib[[1]], regs$pbiy, regs$piy, regs$ip)
savetextables(regs$pib[[1]], NULL, NULL, prefix="behavior")
savetextables(c(regs$pib[[1]][1:4], regs$pib[[2]][1:4]), NULL, NULL, prefix="behavior-NI")
savetextables(c(regs$pib[[1]][1:4]), NULL, NULL, prefix="behavior-cases-stateinfo")
savetextables(c(regs$pib[[2]][1:4]), NULL, NULL, prefix="behavior-cases-nationinfo")
savetextables(NULL, regs$pbiy, regs$piy, prefix="cases")
savetextables(NULL, regs$pbiy[c(1,3)], regs$piy[c(1,3)], prefix="cases-nosplit")
```

```{r casedieff, eval = TRUE, cache=FALSE, warning=FALSE, results='asis'}
for (use.national in c(TRUE,FALSE)) {
  sb <- ifelse(use.national, 2, 1)
  sy <- ifelse(use.national, 3, 1)
  pib <- lapply(regs$pib[[sb]][1:4], function(x) x$reg)
  pbiy <- regs$pbiy[[sy]]$reg
  piy <- regs$piy[[sy]]$reg

  S <- 999
  bs <- bootstrap_felm(sdf, c(pib,list(pbiy,piy)), S=S)

  addse <- function(di, bdi) {
    se <- di*NA
    for (i in 1:length(se)) {
      se[i] <- sd(sapply(bdi, function(b) b[i]))
    }

    tbl <- matrix(NA, nrow=2*nrow(di), ncol=ncol(di))
    for (i in 1:nrow(di)) {
      tbl[2*(i-1) + 1,] <- sapply(1:ncol(di), function(j) printstars(di[i,j], se[i,j]))
      tbl[2*i,] <- sprintf("(%.3f)", se[i,])
    }
    colnames(tbl) <- colnames(di)
    rownames(tbl) <- rep("", nrow(tbl))
    rownames(tbl)[seq(1,nrow(tbl),by=2)] <- relabel(rownames(di))
  return(tbl)
  }

  diall <- dieff_table(lapply(regs$pib[[sb]][1:4], function(x) x$reg$coef[,1]),
                       regs$pbiy[[sy]]$reg$coef[,1],
                       regs$piy[[sy]]$reg$coef[,1],
                       policies=c(pols, infovars[[sb]]), nsum=length(pols))

  bdiall <- lapply(1:S, function(i)
    dieff_table(lapply(1:4, function(j) bs[[j]][,i]),
                bs[[5]][,i], bs[[6]][,i],
                policies=c(pols, infovars[[sb]]), nsum=length(pols))
    )

  tbl <- addse(diall, bdiall)

  #tbl <- tbl[-c(nrow(tbl), nrow(tbl)-1),]

  ltbl <- kable(tbl, digits=2, format="latex", booktabs=TRUE, escape=FALSE,
                linesep="",
                align=(rep("c",ncol(tbl))))  %>%
    column_spec(column=ncol(tbl)+1, border_left=TRUE)
  cat(ltbl, file=paste(rootdir,
                       sprintf("tex/tables_and_figures/dieff-cases-%s.tex",ifelse(use.national, "NI","SI")),
                       sep="/"))

  kable(tbl)
}
```


## Deaths (with deaths as information)

```{r deathtablesd, eval = TRUE, cache=FALSE, warning=FALSE, results='asis'}
df$zero <- 0
infovarsd <- list(c("dlogdd", "logdd"),
                  c("dlogdd", "logdd","dlogdd.national", "logdd.national"))
L <- L.d
sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
regs <- mainregressions(sdf,
                        "dlogdd", pols, bvars, infovarsd, "zero", xlist, ilist, iv, L=L,
                        sameobservations=FALSE)
showhtmltables(regs$pib[[1]], regs$pbiy, regs$piy);
savetextables(regs$pib[[1]], NULL, NULL, prefix="behavior-deathsinfo")
savetextables(c(regs$pib[[1]][1:4], regs$pib[[2]][1:4]), NULL, NULL, prefix="behavior-deathsinfo-NI")
savetextables(c(regs$pib[[1]][1:4]), NULL, NULL, prefix="behavior-deathsinfo-stateinfo")
savetextables(c(regs$pib[[2]][1:4]), NULL, NULL, prefix="behavior-deathsinfo-nationinfo")
savetextables(NULL, regs$pbiy, regs$piy, prefix="deaths-deathsinfo")
savetextables(NULL, regs$pbiy[c(1,3)], regs$piy[c(1,3)], prefix="deaths-deathsinfo-nosplit")
```

```{r dieff-deaths, eval = TRUE, cache=FALSE, results='asis', warning=FALSE}
for (use.national in c(TRUE,FALSE)) {
  sb <- ifelse(use.national, 2, 1)
  sy <- ifelse(use.national, 3, 1)
  pib <- lapply(regs$pib[[sb]][1:4], function(x) x$reg)
  pbiy <- regs$pbiy[[sy]]$reg
  piy <- regs$piy[[sy]]$reg

  S <- 999
  bs <- bootstrap_felm(sdf, c(pib,list(pbiy,piy)), S=S)

  diall <- dieff_table(lapply(regs$pib[[sb]][1:4], function(x) x$reg$coef[,1]),
                       regs$pbiy[[sy]]$reg$coef[,1],
                       regs$piy[[sy]]$reg$coef[,1],
                       policies=c(pols, infovarsd[[sb]]),
                       nsum=length(pols)
                       )

  bdiall <- lapply(1:S, function(i)
    dieff_table(lapply(1:4, function(j) bs[[j]][,i]),
                bs[[5]][,i], bs[[6]][,i],
                policies=c(pols, infovarsd[[sb]]),
                nsum=length(pols)
                ))

  tbl <- addse(diall, bdiall)

  #tbl <- tbl[-c(nrow(tbl), nrow(tbl)-1),]

  ltbl <- kable(tbl, digits=2, format="latex", booktabs=TRUE, escape=FALSE,
                linesep="",
                align=(rep("c",ncol(tbl))))  %>%
    column_spec(column=ncol(tbl)+1, border_left=TRUE)
  cat(ltbl, file=paste(rootdir,
                       sprintf("tex/tables_and_figures/dieff-deaths-deathsinfo-%s.tex",ifelse(use.national, "NI","SI")),
                       sep="/"))
  kable(tbl)
}
```



## Robustness Check
```{r regsrobust,  eval = TRUE, cache=FALSE, warning=FALSE, results='asis'}
infovars <- list(c("dlogdc", "logdc"),
                 c("dlogdc", "logdc","dlogdc.national", "logdc.national"))
tvars <- "dlogtests"
interactions <-list("month", statevars)
ilist <- list(interactions, interactions)
iv <- list("0","0") #,"(testratedc ~ lag(testratedc,14))")

# pi-y with log(vote)
xlist <-list(c("logvote"), c("logvote"))
L <- 14
sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
regs <- mainregressions(sdf,
                        "dlogdc", pols, bvars, infovars, tvars, xlist, ilist, iv, L=L)
showhtmltables(NULL, NULL, NULL, regs$ip)
savetextables(NULL, NULL, NULL, prefix="policy",ip = regs$ip[1:6])


coef.vec.1 <- coef.vec.2 <- coef.vec.3 <- coef.vec.4 <-  rep(0.0, 40)
se.vec.1 <- se.vec.2 <- se.vec.3 <- se.vec.4 <- rep(0.0, 40)

# case growth robustness
sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
piy <- list()
yvar <- "dlogdc"
pols <- c("pmaskbus","pk12","pshelter","pmovie","prestaurant","pnonessential")
for (k in 1:length(infovars)) {
  # (1) baseline
   xlist <-list("","")
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  piy[[(1+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovars[[k]], L),
                tvars, xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (2) excluding NY
   xlist <-list("","")
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  sdf2 <- sdf[which(sdf$state!='New York'),]
  piy[[(2+6*(k-1))]] <- policyreg(sdf2, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovars[[k]], L),
                tvars, xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (3) adding mask wearing rate
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  xlist <-list(c("mask_percent"), c("mask_percent"))
  piy[[(3+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovars[[k]], L),
                tvars, xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (4) adding log(Trump's vote)
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  xlist <-list(c("logvote"), c("logvote"))
  piy[[(4+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovars[[k]], L),
                tvars, xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (5) lagged behavior variables
  sdf <- subset(df, df$date>=as.Date("2020-02-22")) #+L)
  xlist <-list("","")
  piy[[(5+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", bvars, L+14),
                sprintf("lag(%s, %d)", infovars[[k]], L),
                tvars, xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (6) (2)-(5)
   sdf <- subset(df, df$date>=as.Date("2020-02-22")) #+L)
   sdf2 <- sdf[which(sdf$state!='New York'),]
  xlist <-list(c("mask_percent","logvote"), c("mask_percent","logvote"))
   piy[[(6+6*(k-1))]] <- policyreg(sdf2, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", bvars, L+14),
                sprintf("lag(%s, %d)", infovars[[k]], L),
                tvars, xlist[[k]]),
              ilist[[k]], 0, L=L)
}


for (k in 1:6) {
  for (j in 1:3) {
  coef.vec.1[[10*(j-1)+k]] <- piy[[k]]$reg$coefficients[[1+j]]
  se.vec.1[[10*(j-1)+k]] <- piy[[k]]$reg$se[[1+j]]
  coef.vec.2[[10*(j-1)+k]] <- piy[[6+k]]$reg$coefficients[[1+j]]
  se.vec.2[[10*(j-1)+k]] <- piy[[6+k]]$reg$se[[1+j]]
  }
}

colnames(piy[[1]]$reg$response) <- "dlogdc"
showhtmltables(NULL, NULL, piy);
savetextables(NULL, NULL,  piy[1:6], prefix="cases-robust")


# case growth with pindex
pols <- c("pmaskbus","pk12","pshelter","pindex")
for (k in 1:length(infovars)) {
  # (1) baseline
   xlist <-list("","")
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  piy[[(1+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovars[[k]], L),
                tvars, xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (2) excluding NY
   xlist <-list("","")
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  sdf2 <- sdf[which(sdf$state!='New York'),]
  piy[[(2+6*(k-1))]] <- policyreg(sdf2, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovars[[k]], L),
                tvars, xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (3) adding mask wearing rate
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  xlist <-list(c("mask_percent"), c("mask_percent"))
  piy[[(3+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovars[[k]], L),
                tvars, xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (4) adding log(Trump's vote)
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  xlist <-list(c("logvote"), c("logvote"))
  piy[[(4+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovars[[k]], L),
                tvars, xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (5) lagged behavior variables
  sdf <- subset(df, df$date>=as.Date("2020-02-22")) #+L)
  xlist <-list("","")
  piy[[(5+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", bvars, L+14),
                sprintf("lag(%s, %d)", infovars[[k]], L),
                tvars, xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (6) (2)-(5)
   sdf <- subset(df, df$date>=as.Date("2020-02-22")) #+L)
   sdf2 <- sdf[which(sdf$state!='New York'),]
  xlist <-list(c("mask_percent","logvote"), c("mask_percent","logvote"))
   piy[[(6+6*(k-1))]] <- policyreg(sdf2, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", bvars, L+14),
                sprintf("lag(%s, %d)", infovars[[k]], L),
                tvars, xlist[[k]]),
              ilist[[k]], 0, L=L)
}
for (k in 1:6) {
  coef.vec.1[[30+k]] <- piy[[k]]$reg$coefficients[[4]]
  se.vec.1[[30+k]] <- piy[[k]]$reg$se[[4]]
  coef.vec.2[[30+k]] <- piy[[6+k]]$reg$coefficients[[4]]
  se.vec.2[[30+k]] <- piy[[6+k]]$reg$se[[4]]
}


# death growth
L <- L.d
piy <- list()
yvar <- "dlogdd"
infovarsd <- list(c("dlogdd", "logdd"),
                  c("dlogdd", "logdd","dlogdd.national", "logdd.national"))
pols <- c("pmaskbus","pk12","pshelter","pmovie","prestaurant","pnonessential")
for (k in 1:length(infovars)) {
  # (1) baseline
  xlist <-list("","")
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  piy[[(1+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovarsd[[k]], L),
                 xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (2) excluding NY
  xlist <-list("","")
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  sdf2 <- sdf[which(sdf$state!='New York'),]
  piy[[(2+6*(k-1))]] <- policyreg(sdf2, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovarsd[[k]], L),
                 xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (3) adding mask wearing rate
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  xlist <-list(c("mask_percent"), c("mask_percent"))
  piy[[(3+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovarsd[[k]], L),
                 xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (4) adding log(Trump's vote)
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  xlist <-list(c("logvote"), c("logvote"))
  piy[[(4+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovarsd[[k]], L),
                 xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (5) lagged behavior variables
  sdf <- subset(df, df$date>=as.Date("2020-02-22")) #+L)
  xlist <-list("","")
  piy[[(5+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", bvars, L+14),
                sprintf("lag(%s, %d)", infovarsd[[k]], L),
                 xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (6) (2)-(5)
   sdf <- subset(df, df$date>=as.Date("2020-02-22")) #+L)
   sdf2 <- sdf[which(sdf$state!='New York'),]
  xlist <-list(c("mask_percent","logvote"), c("mask_percent","logvote"))
   piy[[(6+6*(k-1))]] <- policyreg(sdf2, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", bvars, L+14),
                sprintf("lag(%s, %d)", infovarsd[[k]], L),
                xlist[[k]]),
              ilist[[k]], 0, L=L)
}
for (k in 1:6) {
  for (j in 1:3) {
  coef.vec.3[[10*(j-1)+k]] <- piy[[k]]$reg$coefficients[[1+j]]
  se.vec.3[[10*(j-1)+k]] <- piy[[k]]$reg$se[[1+j]]
  coef.vec.4[[10*(j-1)+k]] <- piy[[6+k]]$reg$coefficients[[1+j]]
  se.vec.4[[10*(j-1)+k]] <- piy[[6+k]]$reg$se[[1+j]]
  }
}

colnames(piy[[1]]$reg$response) <- "dlogdd"
showhtmltables(NULL, NULL, piy);
savetextables(NULL, NULL,  piy[1:6], prefix="deaths-robust")

# death growth with pindex
pols <- c("pmaskbus","pk12","pshelter","pindex")
for (k in 1:length(infovars)) {
  # (1) baseline
  xlist <-list("","")
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  piy[[(1+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovarsd[[k]], L),
                 xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (2) excluding NY
  xlist <-list("","")
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  sdf2 <- sdf[which(sdf$state!='New York'),]
  piy[[(2+6*(k-1))]] <- policyreg(sdf2, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovarsd[[k]], L),
                 xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (3) adding mask wearing rate
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  xlist <-list(c("mask_percent"), c("mask_percent"))
  piy[[(3+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovarsd[[k]], L),
                 xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (4) adding log(Trump's vote)
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  xlist <-list(c("logvote"), c("logvote"))
  piy[[(4+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovarsd[[k]], L),
                 xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (5) lagged behavior variables
  sdf <- subset(df, df$date>=as.Date("2020-02-22")) #+L)
  xlist <-list("","")
  piy[[(5+6*(k-1))]] <- policyreg(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", bvars, L+14),
                sprintf("lag(%s, %d)", infovarsd[[k]], L),
                 xlist[[k]]),
              ilist[[k]], 0, L=L)
  # (6) (2)-(5)
   sdf <- subset(df, df$date>=as.Date("2020-02-22")) #+L)
   sdf2 <- sdf[which(sdf$state!='New York'),]
  xlist <-list(c("mask_percent","logvote"), c("mask_percent","logvote"))
   piy[[(6+6*(k-1))]] <- policyreg(sdf2, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", bvars, L+14),
                sprintf("lag(%s, %d)", infovarsd[[k]], L),
                xlist[[k]]),
              ilist[[k]], 0, L=L)
}
for (k in 1:6) {
  coef.vec.3[[30+k]] <- piy[[k]]$reg$coefficients[[4]]
  se.vec.3[[30+k]] <- piy[[k]]$reg$se[[4]]
  coef.vec.4[[30+k]] <- piy[[6+k]]$reg$coefficients[[4]]
  se.vec.4[[30+k]] <- piy[[6+k]]$reg$se[[4]]
}


```


## Fixed Effects
```{r regsfe,  eval = FALSE, cache=FALSE, warning=FALSE, results='asis'}

source(paste(rootdir,"cases_and_policies/rmd/debiasedfe.R", sep="/"))

df$pindex <- (df$pmovie+df$prestaurant+df$pnonessential)/3

yvar <- "dlogdc"
infovars <- list(c("dlogdc", "logdc"),
                 c("dlogdc", "logdc","dlogdc.national", "logdc.national"))
tvars <- "dlogtests"
L <- L.c
sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
piy <- list()

#' Update the coefficients of felm object.  Also updates the t stats
#' and p values, so that summary and stargazer work correctly after.
replacecoef <- function(reg, newcoef) {
  reg$beta[] <- newcoef
  reg$coefficients[] <- newcoef
  reg$tval <- reg$beta/reg$se
  reg$pval <- pt(-abs(reg$tval),df=reg$df)*2
  reg$rtval <- reg$beta/reg$rse
  reg$rpval <- pt(-abs(reg$rtval),df=reg$df)*2
  reg$ctval <- reg$beta/reg$cse
  reg$cpval <- pt(-abs(reg$ctval),df=reg$df)*2
  return(reg)
}

for (k in 1:length(infovars)) {
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  pols <- c("pmaskbus","pk12","pshelter","pmovie","prestaurant","pnonessential")
  m <-  reg_fe(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovars[[k]], L),
                tvars), 0, L, "state + month")
  piy[[(1+4*(k-1))]] <- m
  m$reg <- replacecoef(m$reg, m$bc2)
  piy[[(2+4*(k-1))]] <- m
  pols <- c("pmaskbus","pk12","pshelter","pindex")
  m <-  reg_fe(sdf, yvar, pols, NULL,
              c(sprintf("lag(%s, %d)", infovars[[k]], L),
                tvars), 0, L, "state + month")
  piy[[(3+4*(k-1))]] <- m
  m$reg$beta[1:(6+2*(k-1))] <- m$bc2[1:(6+2*(k-1))]
  piy[[(4+4*(k-1))]] <- m
}

for (j in 1:3) {
  coef.vec.1[[10*(j-1)+9]] <- piy[[1]]$reg$beta[[j]]
  se.vec.1[[10*(j-1)+9]] <- piy[[1]]$reg$se[[j]]
  coef.vec.1[[10*(j-1)+10]] <- piy[[2]]$reg$beta[[j]]
  se.vec.1[[10*(j-1)+10]] <- piy[[1]]$reg$se[[j]]
  coef.vec.2[[10*(j-1)+9]] <- piy[[5]]$reg$beta[[j]]
  se.vec.2[[10*(j-1)+9]] <- piy[[5]]$reg$se[[j]]
  coef.vec.2[[10*(j-1)+10]] <- piy[[6]]$reg$beta[[j]]
  se.vec.2[[10*(j-1)+10]] <- piy[[5]]$reg$se[[j]]
}
coef.vec.1[[30+9]] <- piy[[3]]$reg$beta[[3]]
se.vec.1[[30+9]] <- piy[[3]]$reg$se[[3]]
coef.vec.1[[30+10]] <- piy[[4]]$reg$beta[[3]]
se.vec.1[[30+10]] <- piy[[3]]$reg$se[[3]]
coef.vec.2[[30+9]] <- piy[[7]]$reg$beta[[3]]
se.vec.2[[30+9]] <- piy[[7]]$reg$se[[3]]
coef.vec.2[[30+10]] <- piy[[8]]$reg$beta[[3]]
se.vec.2[[30+10]] <- piy[[7]]$reg$se[[3]]

colnames(piy[[1]]$reg$response) <- "dlogdc"
showhtmltables(NULL, NULL,  piy);
prefix="cases-fe"
#savetextables(NULL, NULL, piy[1:4], prefix="cases-fe") copying and

# pasting this is bad style and seems like it might create maintenance
# problems ...
   ylbl <- colnames(piy[[1]]$reg$response)
    if (ylbl=="dlogdd") ylbl <- "Death Growth"
    if (ylbl=="dlogdc") ylbl <- "Case Growth"

    tbl <- capture.output(stargazer(
        lapply(piy[1:4], function(x) x$reg),
        type="latex",
        dep.var.labels.include=FALSE,
        title=ylbl,
        # omit=omit,
        # omit.labels=omit.labels,
        column.labels=c(yvar),
        column.separate=c(length(piy[1:4])),
        # add.lines=list(c("$\\sum_j \\mathrm{Policy}_j$",
        #                  sapply(piy, function(x) printstars(x$peff[1], x$peff[2]))),
        #                c("",
        #                  sprintf("(%.3f)",sapply(piy, function(x) x$peff[2])))
        #                ),
        omit.stat=c("f", "ser"), model.names=FALSE,
        no.space=TRUE,
        column.sep.width="1pt",
        df=FALSE, header=FALSE,
        model.numbers=TRUE))
    tbl <- relabel(tbl)
    tbl <- gsub("Model (\\d)", "\\(\\1\\)", tbl)
    #tbl <- gsub("No","Yes", tbl)
    texfile <- sprintf("%s/tex/tables_and_figures/%s-piy.tex",rootdir,prefix)
    cat(paste(tbl[c(-1,-2,-3,-4, -length(tbl))], collapse="\n"), file=texfile)

yvar <- "dlogdd"
infovars <- list(c("dlogdd", "logdd"),
                  c("dlogdd", "logdd","dlogdd.national", "logdd.national"))
L <- L.d
sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
piy <- list()
for (k in 1:length(infovars)) {
  sdf <- subset(df, df$date>=as.Date("2020-03-07")) #+L)
  pols <- c("pmaskbus","pk12","pshelter","pmovie","prestaurant","pnonessential")
  m <-  reg_fe(sdf, yvar, pols, NULL,
              sprintf("lag(%s, %d)", infovars[[k]], L), 0, L, "state + month")
  piy[[(1+4*(k-1))]] <- m
  m$reg <- replacecoef(m$reg, m$bc2)
  piy[[(2+4*(k-1))]] <- m
  pols <- c("pmaskbus","pk12","pshelter","pindex")
  m <-  reg_fe(sdf, yvar, pols, NULL,
              sprintf("lag(%s, %d)", infovars[[k]], L), 0, L, "state + month")
  piy[[(3+4*(k-1))]] <- m
  m$reg <- replacecoef(m$reg, m$bc2)
  piy[[(4+4*(k-1))]] <- m
}

for (j in 1:3) {
  coef.vec.3[[10*(j-1)+9]] <- piy[[1]]$reg$beta[[j]]
  se.vec.3[[10*(j-1)+9]] <- piy[[1]]$reg$se[[j]]
  coef.vec.3[[10*(j-1)+10]] <- piy[[2]]$reg$beta[[j]]
  se.vec.3[[10*(j-1)+10]] <- piy[[1]]$reg$se[[j]]
  coef.vec.4[[10*(j-1)+9]] <- piy[[5]]$reg$beta[[j]]
  se.vec.4[[10*(j-1)+9]] <- piy[[5]]$reg$se[[j]]
  coef.vec.4[[10*(j-1)+10]] <- piy[[6]]$reg$beta[[j]]
  se.vec.4[[10*(j-1)+10]] <- piy[[5]]$reg$se[[j]]
}
coef.vec.3[[30+9]] <- piy[[3]]$reg$beta[[3]]
se.vec.3[[30+9]] <- piy[[3]]$reg$se[[3]]
coef.vec.3[[30+10]] <- piy[[4]]$reg$beta[[3]]
se.vec.3[[30+10]] <- piy[[3]]$reg$se[[3]]
coef.vec.4[[30+9]] <- piy[[7]]$reg$beta[[3]]
se.vec.4[[30+9]] <- piy[[7]]$reg$se[[3]]
coef.vec.4[[30+10]] <- piy[[8]]$reg$beta[[3]]
se.vec.4[[30+10]] <- piy[[7]]$reg$se[[3]]


colnames(piy[[1]]$reg$response) <- "dlogdd"
showhtmltables(NULL, NULL,  piy);
prefix="deaths-fe"
#savetextables(NULL, NULL, piy[1:4], prefix="cases-fe")
   ylbl <- colnames(piy[[1]]$reg$response)
    if (ylbl=="dlogdd") ylbl <- "Death Growth"
    if (ylbl=="dlogdc") ylbl <- "Case Growth"

    tbl <- capture.output(stargazer(
        lapply(piy[1:4], function(x) x$reg),
        type="latex",
        dep.var.labels.include=FALSE,
        title=ylbl,
        # omit=omit,
        # omit.labels=omit.labels,
        column.labels=c(yvar),
        column.separate=c(length(piy[1:4])),
        # add.lines=list(c("$\\sum_j \\mathrm{Policy}_j$",
        #                  sapply(piy, function(x) printstars(x$peff[1], x$peff[2]))),
        #                c("",
        #                  sprintf("(%.3f)",sapply(piy, function(x) x$peff[2])))
        #                ),
        omit.stat=c("f", "ser"), model.names=FALSE,
        no.space=TRUE,
        column.sep.width="1pt",
        df=FALSE, header=FALSE,
        model.numbers=TRUE))
    tbl <- relabel(tbl)
    tbl <- gsub("Model (\\d)", "\\(\\1\\)", tbl)
    #tbl <- gsub("No","Yes", tbl)
    texfile <- sprintf("%s/tex/tables_and_figures/%s-piy.tex",rootdir,prefix)
    cat(paste(tbl[c(-1,-2,-3,-4, -length(tbl))], collapse="\n"), file=texfile)
```

## DML
```{r regsdml,  eval = TRUE, cache=TRUE, warning=FALSE, results='asis'}


df$logpop <- log(df$Population.2018)
df$logsq <- log(df$Square.Miles)
df$repub <- as.factor(df$party)
df$party_dum <- ifelse(df$party == "republican", 0, 1)
df$month3 <- ifelse(df$month==3,0,1)
df$month4 <- ifelse(df$month==4,0,1)
df$month5 <- ifelse(df$month==5,0,1)
df$month6 <- ifelse(df$month==6,0,1)
L <- L.c

pols <- c("pmaskbus","pk12","pshelter","pmovie","prestaurant","pnonessential")
infovars <- list(c("dlogdc", "logdc"),
                 c("dlogdc", "logdc","dlogdc.national", "logdc.national"))
infovarsd <- list(c("dlogdd", "logdd"),
                  c("dlogdd", "logdd","dlogdd.national", "logdd.national"))
vars <- c(infovars[[2]],infovarsd[[2]],pols,"pindex")
for(i in 1:length(vars)) {
  L<-L.c
  v <- sprintf("%s.L14",vars[i])
  df[,v] <- panellag(df[,vars[i]],df$state,df$date, lag=L)
  L<-L.d
  v <- sprintf("%s.L21",vars[i])
  df[,v] <- panellag(df[,vars[i]],df$state,df$date, lag=L)
}

for(i in 1:length(bvars)) {
  L<-L.c
  v <- sprintf("%s.L14",bvars[i])
  df[,v] <- panellag(df[,bvars[i]],df$state,df$date, lag=L+14)
  L<-L.d
  v <- sprintf("%s.L21",bvars[i])
  df[,v] <- panellag(df[,bvars[i]],df$state,df$date, lag=L+14)
}

# df$test <- df$dlogtests
# df$test[is.na(df$test)] <- 0

svars <- c("logpop","logsq","Percent.Unemployed..2018.",
               "Percent.living.under.the.federal.poverty.line..2018.",
               "Percent.at.risk.for.serious.illness.due.to.COVID","party_dum")
mvars <- c("month4","month5","month6")
ijs <- expand.grid(1:length(svars), 1:length(mvars))
msvars <- vector(mode="character", length=lengths(ijs)[[1]])
for (ij in (1:lengths(ijs)[[1]])){
  v <-  sprintf("%s.%s",svars[ijs[[1]][ij]],mvars[ijs[[2]][ij]])
  msvars[ij] <- v
  df[,v] <- df[,svars[ijs[[1]][ij]]]*df[,mvars[ijs[[2]][ij]]]
}

wvars <- c(svars,mvars,msvars,"month3","mask_percent","logvote","test")
wvars.d <- c(svars,mvars,msvars,"month3","mask_percent","logvote")

bvars.c <- c("workplaces.L14","retail.L14","grocery.L14","transit.L14")
bvars.d <- c("workplaces.L21","retail.L21","grocery.L21","transit.L21")
xvars <- c(bvars.c,"dlogdc.L14","logdc.L14")
xvars.national <- c(bvars.c,"dlogdc.L14","logdc.L14","dlogdc.national.L14","logdc.national.L14")
xvars.d <- c(bvars.d,"dlogdd.L21","logdd.L21")
xvars.national.d <- c(bvars.d,"dlogdd.L21","logdd.L21","dlogdd.national.L21","logdd.national.L21")

pols.L14 <- c("pmaskbus.L14","pk12.L14","pshelter.L14","pmovie.L14","prestaurant.L14","pnonessential.L14")
pols.L21 <- c("pmaskbus.L21","pk12.L21","pshelter.L21","pmovie.L21","prestaurant.L21","pnonessential.L21")

pols.L14 <- c("pmaskbus.L14","pk12.L14","pshelter.L14","pmovie.L14","prestaurant.L14","pnonessential.L14")
pols.L21 <- c("pmaskbus.L21","pk12.L21","pshelter.L21","pmovie.L21","prestaurant.L21","pnonessential.L21")


AM<- function(yv, xv, wv, sdf, reg,  steps=5){
 y <- sdf[,yv]
 w <- sdf[,wv]
 sdf[,"y"] <- y
 # Initialize
 fmla <- as.formula(paste("y", "~",  paste(xv, collapse=" + "), sep=" "))
 g1 <- predict(lm(fmla, data=sdf))
 m1 <- predict(reg(w,as.vector(y- g1)))
 i<-1
 while(i<= steps) {
  sdf$y <- y-m1
  g1 <- predict(lm(fmla, data=sdf))
  m1 <- predict(reg(w,as.vector(y-g1)))
  i <- i+1 }
 fitx <- lm(fmla, data=sdf)
 fitw <- reg(w,as.vector(y-g1))
 return(list(x=fitx , w = fitw))
}

DML2.for.PLM <- function(xv, wv, dv, yv, reg, sdf, nfold=5) {
  unit <- as.double(sdf$state)
  j <-  quantile(unit, c(1:(nfold-1))/nfold)
  I <- vector(mode = "list", length = nfold)
  I[[1]] <- unit <= j[1]
  for (b in 2:(nfold-1)) {
    I[[b]] <- (unit <= j[b])&(unit > j[b-1])
  }
  I[[nfold]] <- unit > j[nfold-1]
  nobs <- nrow(sdf)
  ytil <- dtil <- rep(NA, nobs)
  w <- as.matrix(sdf[,wv])
  x <- as.matrix(sdf[,xv])
  d <- as.vector(sdf[,dv])
  y <- as.vector(sdf[,yv])
  for(b in 1:nfold){
    I1 <- (I[[b]]==FALSE)
    I2 <- I[[b]]
    yfit <- AM(yv, xv, wv, sdf[I1,], reg)
    dfit <- AM(dv, xv, wv, sdf[I1,], reg)
    yhat <- predict(yfit$x,newdata=sdf[I2,]) + predict(yfit$w, w[I2,], type="response")
    dhat <- predict(dfit$x,newdata=sdf[I2,])+ predict(dfit$w, w[I2,], type="response")
    dtil[I2] <- (d[I2] - dhat) #record residual
    ytil[I2] <- (y[I2] - yhat) #record residual
    cat(b," ")
  }
sdf$ytil <- ytil
sdf$dtil <- dtil
rfit <- felm(ytil ~ dtil| 0| 0 | state, data=sdf) #estimate the main parameter by regressing one residual on the other
coef.est <- coef(rfit)[2] #extract coefficient
se <- sqrt(vcov(rfit)[2,2])
cat(sprintf("\ncoef (se) = %g (%g)\n", coef.est , se))
return( list(coef.est = coef.est , se=se) )
}

# DML2.for.PLM <- function(x, d, y, dreg, yreg, sdf, nfold=5) {
#   unit <- as.double(sdf$state)
#   j <-  quantile(unit, c(1:(nfold-1))/nfold)
#   I <- vector(mode = "list", length = nfold)
#   I[[1]] <- unit <= j[1]
#   for (b in 2:(nfold-1)) {
#     I[[b]] <- (unit <= j[b])&(unit > j[b-1])
#   }
#   I[[nfold]] <- unit > j[nfold-1]
#   nobs <- nrow(x)
#   ytil <- dtil <- rep(NA, nobs)
#   for(b in 1:nfold){
#     I1 <- (I[[b]]==FALSE)
#     I2 <- I[[b]]
#     dfit <- dreg(x[I1,], d[I1]) # take a fold out
#     yfit <- yreg(x[I1,], y[I1]) # take a fold out
#     dhat <- predict(dfit, x[I2,], type="response") #predict the fold out
#     yhat <- predict(yfit, x[I2,], type="response") #predict the fold out
#     dtil[I2] <- (d[I2] - dhat) #record residual
#     ytil[I2] <- (y[I2] - yhat) #record residual
#     cat(b," ")
#   }
# sdf$ytil <- ytil
# sdf$dtil <- dtil
# rfit <- felm(ytil ~ dtil| 0| 0 | state, data=sdf) #estimate the main parameter by regressing one residual on the other
# coef.est <- coef(rfit)[2] #extract coefficient
# se <- sqrt(vcov(rfit)[2,2])
# cat(sprintf("\ncoef (se) = %g (%g)\n", coef.est , se))
# return( list(coef.est = coef.est , se=se) )
# }



nfold <- 5

penalty = list(homoscedastic = FALSE, X.dependent.lambda =
  FALSE, lambda.start = NULL, c = 1.7, gamma = 0.1)
reg.lasso <- function(x,y){ rlasso(x, y, penalty=penalty) } #ML method= rlasso
# dreg <- function(x,d){ cv.glmnet(x, d) } #ML method= rlasso
# yreg <- function(x,y){ cv.glmnet(x, y) } #ML method = rlasso
reg.RF <- function(x,y){ randomForest(x, y, maxnodes=8) } #ML method=Forest
for (j in 1:4){
  sdf <- subset(df, df$date>=as.Date(sprintf("2020-03-%s",7+L.c)))
  # y = sdf$dlogdc
  yv <- "dlogdc"
  wv <- wvars
  if (j==1){
    dv <- "pmaskbus.L14"
    p <- pols.L14[-1]
    # d = sdf$pmaskbus.L14
  } else if (j==2) {
    dv <- "pk12.L14"
    p <- pols.L14[-2]
    # d = sdf$pk12.L14
  } else if (j==3) {
    dv <- "pshelter.L14"
    p <- pols.L14[-3]
    # d = sdf$pshelter.L14
  } else if (j==4) {
    dv <- "pindex.L14"
    p <- pols.L14[1:3]
    # d = sdf$pindex.L14
  }
  # case growth without national
  # x = as.matrix(cbind(sdf[,p],sdf[,xvars]))
  xv <- c(xvars,p)
  set.seed(1)
  DML2.lasso <- DML2.for.PLM(xv, wv, dv, yv, reg.lasso, sdf, nfold = nfold)
  coef.vec.1[[10*(j-1)+7]] <- DML2.lasso$coef.est
  se.vec.1[[10*(j-1)+7]] <- DML2.lasso$se
  set.seed(1)
  DML2.RF <- DML2.for.PLM(xv, wv, dv, yv, reg.RF, sdf, nfold=10)
  coef.vec.1[[10*(j-1)+8]] <- DML2.RF$coef.est
  se.vec.1[[10*(j-1)+8]] <- DML2.RF$se
  # case growth with national
  xv <- c(xvars.national,p)
  # x = as.matrix(cbind(sdf[,p],sdf[,xvars.national]))
  set.seed(1)
  DML2.lasso <- DML2.for.PLM(xv, wv, dv, yv, reg.lasso, sdf, nfold = nfold)
  coef.vec.2[[10*(j-1)+7]] <- DML2.lasso$coef.est
  se.vec.2[[10*(j-1)+7]] <- DML2.lasso$se
  set.seed(1)
  DML2.RF <- DML2.for.PLM(xv, wv, dv, yv, reg.RF, sdf, nfold = nfold)
  coef.vec.2[[10*(j-1)+8]] <- DML2.RF$coef.est
  se.vec.2[[10*(j-1)+8]] <- DML2.RF$se
  ## death growth
  sdf <- subset(df, df$date>=as.Date(sprintf("2020-03-%s",7+L.d)))
  yv <- "dlogdd"
  wv <- wvars.d
  # y = sdf$dlogdd
  # sdf <- sdf[which(sdf$state!='New York'),]
    if (j==1){
    dv <- "pmaskbus.L21"
    p <- pols.L21[-1]
    # d = sdf$pmaskbus.L21
  } else if (j==2) {
    dv <- "pk12.L21"
    p <- pols.L21[-2]
    # d = sdf$pk12.L21
  } else if (j==3) {
    dv <- "pshelter.L21"
    p <- pols.L21[-3]
    # d = sdf$pshelter.L21
  } else if (j==4) {
    dv <- "pindex.L21"
    p <- pols.L21[1:3]
    # d = sdf$pindex.L21
  }
  # death growth without national
  # x = as.matrix(cbind(sdf[,p],sdf[,xvars.d]))
  xv <- c(xvars.d,p)
  set.seed(1)
  DML2.lasso <- DML2.for.PLM(xv, wv, dv, yv, reg.lasso, sdf, nfold = nfold)
  coef.vec.3[[10*(j-1)+7]] <- DML2.lasso$coef.est
  se.vec.3[[10*(j-1)+7]] <- DML2.lasso$se
  set.seed(1)
  DML2.RF <- DML2.for.PLM(xv, wv, dv, yv, reg.RF, sdf, nfold = nfold)
  coef.vec.3[[10*(j-1)+8]] <- DML2.RF$coef.est
  se.vec.3[[10*(j-1)+8]] <- DML2.RF$se
  # death growth with national vars
  # x = as.matrix(cbind(sdf[,p],sdf[,xvars.national.d]))
  xv <- c(xvars.national.d,p)
  set.seed(1)
  DML2.lasso <- DML2.for.PLM(xv, wv, dv, yv, reg.lasso, sdf, nfold = nfold)
  coef.vec.4[[10*(j-1)+7]] <- DML2.lasso$coef.est
  se.vec.4[[10*(j-1)+7]] <- DML2.lasso$se
  set.seed(1)
  DML2.RF <- DML2.for.PLM(xv, wv, dv, yv, reg.RF, sdf, nfold = nfold)
  coef.vec.4[[10*(j-1)+8]] <- DML2.RF$coef.est
  se.vec.4[[10*(j-1)+8]] <- DML2.RF$se
}



# WARNINGS!  dplyr and dotwhisker seem to interfare with our regression codes --- need to call them only after calling regression codes; otherwise, they will improperly change our regression results
library(dplyr)
library(dotwhisker)
var.names <- c("(1) baseline    ","(2) excluding NY","(3) mask wearing","(4) Trump's vote ","(5) behavior vars"," (6) all of (2)-(5)  ",  "(7) DML (Lasso)", "(8) DML (RF)  ", "(9) FE with BC")

# mask coefficient
ij <- c(1:8,10)
 results_df <- data.frame(term = rep(var.names, times = 4),
                         estimate = c(coef.vec.1[ij], coef.vec.2[ij],coef.vec.3[ij], coef.vec.4[ij]),
                         std.error = c(se.vec.1[ij], se.vec.2[ij],se.vec.3[ij], se.vec.4[ij]),
                         model = c(rep("case w/o national", 9), rep("case w/ national", 9),
                                   rep("death w/o national",9), rep("death wi/ national", 9)),
                         stringsAsFactors = FALSE)
 # Draw dot-and-whisker plot
fig <- dwplot(results_df, conf.level = .90) + theme_bw() +
    theme(       legend.justification=c(.01, .999), legend.position=c(.63, .99),
           legend.title = element_blank(), legend.background =
              element_rect(color="gray90")) +
    xlab("coefficients of masks for employees") +
    geom_vline(xintercept = 0, colour = "grey60", linetype = 2) +
  theme(text=element_text(family="Times New Roman", face="bold", size=8)) +
   xlim(-0.55, 0.4) +theme(
  legend.title = element_text(size = 6),
  legend.text = element_text(size = 6)
  )# + ggtitle("Mask Mandates")
p <- "pmaskbus"
figdev(sprintf("%s/tex/tables_and_figures/%s-whisker-%s.pdf", rootdir, p, L.c), width=4, height=3)
print(fig)
dev.off()
fig

# school coefficient
ij <- c(11:18,20)
 results_df <- data.frame(term = rep(var.names, times = 4),
                         estimate = c(coef.vec.1[ij], coef.vec.2[ij],coef.vec.3[ij], coef.vec.4[ij]),
                         std.error = c(se.vec.1[ij], se.vec.2[ij],se.vec.3[ij], se.vec.4[ij]),
                         model = c(rep("case w/o national", 9), rep("case w/ national", 9),
                                   rep("death w/o national",9), rep("death w/ national", 9)),
                         stringsAsFactors = FALSE)
fig <- dwplot(results_df, conf.level = .90) + theme_bw() +
    theme(
       legend.justification=c(.01, .999), legend.position=c(.01,.99),
    # legend.position = c(.95, .95),
    # legend.justification = c("right", "top"),
    # legend.box.just = "right",
           legend.title = element_blank(), legend.background =
              element_rect(color="gray90")) +
    xlab("coefficients of closed K-12 schools") +
    geom_vline(xintercept = 0, colour = "grey60", linetype = 2) +
  theme(text=element_text(family="Times New Roman", face="bold", size=8)) +
  xlim(-1.4, 0.5)  +theme(
  legend.title = element_text(size = 6),
  legend.text = element_text(size = 5)
  )# + ggtitle("School Closures")
p <- "pk12"
figdev(sprintf("%s/tex/tables_and_figures/%s-whisker-%s.pdf", rootdir, p, L.c), width=4, height=3)
print(fig)
dev.off()
fig


# stay-at-home coefficient
ij <- c(21:28,30)
 results_df <- data.frame(term = rep(var.names, times = 4),
                         estimate = c(coef.vec.1[ij], coef.vec.2[ij],coef.vec.3[ij], coef.vec.4[ij]),
                         std.error = c(se.vec.1[ij], se.vec.2[ij],se.vec.3[ij], se.vec.4[ij]),
                         model = c(rep("case w/o national", 9), rep("case w/ national", 9),
                                   rep("death w/o national",9), rep("death w/ national", 9)),
                         stringsAsFactors = FALSE)
fig <- dwplot(results_df, conf.level = .90) + theme_bw() +
    theme(       legend.justification=c(.01, .999), legend.position=c(.63, .99),
           legend.title = element_blank(), legend.background =
              element_rect(color="gray90")) +
    xlab("coefficients of stay-at-home") +
    geom_vline(xintercept = 0, colour = "grey60", linetype = 2) +
  theme(text=element_text(family="Times New Roman", face="bold", size=8)) +
   xlim(-0.55, 0.4) +theme(
  legend.title = element_text(size = 6),
  legend.text = element_text(size = 6)
  )
# + ggtitle("Stay-at-home Orders")
p <- "pshelter"
figdev(sprintf("%s/tex/tables_and_figures/%s-whisker-%s.pdf", rootdir, p, L.c), width=4, height=3)
print(fig)
dev.off()
fig


# pindex coefficient
ij <- c(31:38,40)
 results_df <- data.frame(term = rep(var.names, times = 4),
                         estimate = c(coef.vec.1[ij], coef.vec.2[ij],coef.vec.3[ij], coef.vec.4[ij]),
                         std.error = c(se.vec.1[ij], se.vec.2[ij],se.vec.3[ij], se.vec.4[ij]),
                         model = c(rep("case w/o national", 9), rep("case w/ national", 9),
                                   rep("death w/o national",9), rep("death w/ national", 9)),
                         stringsAsFactors = FALSE)
fig <- dwplot(results_df, conf.level = .90) + theme_bw() +
    theme(       legend.justification=c(.01, .999), legend.position=c(.67, .99),
           legend.title = element_blank(), legend.background =
              element_rect(color="gray90")) +
    xlab("coefficients of average of four policy variables") +
    geom_vline(xintercept = 0, colour = "grey60", linetype = 2) +
  theme(text=element_text(family="Times New Roman", face="bold", size=8)) +
  xlim(-0.55, 0.4) +theme(
  legend.title = element_text(size = 6),
  legend.text = element_text(size = 5)
  )# + ggtitle("Average of Four Policy Variables")
p <- "pindex"
figdev(sprintf("%s/tex/tables_and_figures/%s-whisker-%s.pdf", rootdir, p, L.c), width=4, height=3)
print(fig)
dev.off()
fig


```



# Figures

## Policy

The following plot illustrates the effect of mandatory masks for
employees.  The lighter line is the average across states that did not
have mask policy 14 days ago of case growth rate. The darker line is
the average across states that did have a mask policy 14 days
ago. (It's actually the fit from regressing dlogdc on date dummies
interacted with the 14 day lagged, 7 day moving average of a mask
policy indicator). Light points are the state observations without a
mask policy. Dark points are states with a mask policy 14 days ago.

```{r fig, cache=FALSE,  fig_width=10, fig_height=6, warning=FALSE}
pfigure <- function(df, pol, stlab=1, outcome="dlogdc", L=14) {
  df$p <- panellag(df[,pol],df$state, df$date, L)
  df$p <- ceiling(df$p)
  df$y <- df[,outcome]
  df$week <- week(df$date)
  m <- lm(y ~ as.factor(date) + as.factor(date):p, data=df)
  adf <- rbind(data.frame(date=m$xlevels$`as.factor(date)`, p=0),
               data.frame(date=m$xlevels$`as.factor(date)`, p=1))
  adf$week <- week(as.Date(adf$date))
  pred <- predict(m, newdata=adf, interval="confidence")
  adf$hat <- pred[,"fit"]
  adf$lo <- pred[,"lwr"]
  adf$hi <- pred[,"upr"]
  adf$date <- as.Date(adf$date)
  if (stlab==1) {
    pdf <- subset(df, df$p<=0.01)
    ldf <- subset(df, df$p>0.01)
  } else if (stlab==0) {
    pdf <- subset(df, df$p>=0.99)
    ldf <- subset(df, df$p<0.99)
  } else {
    pdf <- df
    ldf <- NULL #data.frame(date=NA,y=NA,ST=NA,p=NA)
  }
  clrs <- solarized_pal(2)(2)
  fig <- ggplot(df,aes(color=p)) +
    geom_point(data=pdf,aes(x=date, y=y, color=p),alpha=0.3, size=0.5) +
    xlim(c(as.Date("2020-04-10"), max(df$date))) +
    geom_line(data=adf, aes(x=date, y=hat, group=p), size=2) +
    figtheme + scale_color_gradient(low=clrs[1], high=clrs[2]) + #colors_grad(palette="Green-Gold") +
    theme(legend.position="none") +
    xlab("") +
    ylim(c(-0.65,0.4))
  if (!is.null(ldf))
    fig <- fig +
      geom_text(data=ldf,
                aes(x=date, y=y, label=ST, color=p), alpha=1.0, size=5)
  return(fig)
}
fig <- pfigure(df, "pmaskbus", stlab=-1,L=L.c) + ggtitle(TeX(relabel("dlogdc given pmaskbus"))) + ylab(TeX(relabel("dlogdc")))

p <- "pmaskbus"
figdev(sprintf("%s/tex/tables_and_figures/%s-cases-%s.pdf", rootdir, p, L.c), width=4, height=3)
print(fig)
dev.off()
fig
```

We now look at similar figures for other policies.

```{r polplots, cache=FALSE, fig_width=10, fig_height=6}
fig <- pfigure(df, "pk12", stlab=-1,L=L.c) +
  ggtitle(TeX(relabel("dlogdc given pk12"))) +
   xlim(c(as.Date("2020-03-21"), as.Date("2020-05-01"))) +
  ylim(c(-0.6,2)) + ylab(TeX(relabel("dlogdc")))

p <- "pk12"
figdev(sprintf("%s/tex/tables_and_figures/%s-cases-%s.pdf", rootdir, p, L.c), width=4, height=3)
print(fig)
dev.off()
fig

for (p in pols[3:length(pols)]) {
  fig <- pfigure(df, p, stlab=-1) +
    ggtitle(TeX(relabel(sprintf("dlogdc given %s",p)))) +
    xlim(c(as.Date("2020-04-01"), max(df$date))) +
    ylim(c(-1,1)) + ylab(TeX(relabel("dlogdc")))
  figdev(sprintf("%s/tex/tables_and_figures/%s-cases-%s.pdf", rootdir, p, L.c), width=4, height=3)
  print(fig)
  dev.off()
}
```

# Death Growth Plots

```{r poldeathsplots, cache=FALSE, fig_width=10, fig_height=6, warning=FALSE}
fig <- pfigure(df, "pmaskbus", stlab=-1, outcome="dlogdd", L=L.d) +
  ggtitle(TeX(relabel("dlogdd given pmaskbus"))) +
  ylab(TeX(relabel("dlogdd")))

p <- "pmaskbus"
figdev(sprintf("%s/tex/tables_and_figures/%s-deaths-%s.pdf", rootdir, p, L.d),width=4, height=3)
print(fig)
dev.off()
fig



fig <- pfigure(df, "pk12", stlab=-1, outcome="dlogdd", L=L.d) +
  ggtitle(TeX(relabel("dlogdd given pk12"))) +
   xlim(c(as.Date("2020-03-21"), as.Date("2020-05-01"))) +
  ylim(c(-0.6,2)) + ylab(TeX(relabel("dlogdd")))

p <- "pk12"
figdev(sprintf("%s/tex/tables_and_figures/%s-deaths-%s.pdf", rootdir, p, L.d),width=4, height=3)
print(fig)
dev.off()

for (p in pols[3:length(pols)]) {
  fig <- pfigure(df, p, stlab=-1, outcome="dlogdd", L=L.d) +
    ggtitle(TeX(relabel(sprintf("dlogdd given %s",p)))) +
    xlim(c(as.Date("2020-04-01"), max(df$date))) +
    ylim(c(-1,1)) + ylab(TeX(relabel("dlogdd")))
  figdev(sprintf("%s/tex/tables_and_figures/%s-deaths-%s.pdf", rootdir, p, L.d), width=4, height=3)
  print(fig)
  dev.off()
}
```



```{r, results='asis', echo=FALSE}
if (!knitr::is_latex_output()) {
  cat("
[![](https://i.creativecommons.org/l/by-sa/4.0/88x31.png)](http://creativecommons.org/licenses/by-sa/4.0/)

This work is licensed under a [Creative Commons Attribution-ShareAlike
4.0 International License](http://creativecommons.org/licenses/by-sa/4.0/)
") }
```
